!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("alloyfinger"),require("vue")):"function"==typeof define&&define.amd?define(["alloyfinger","vue"],e):(t="undefined"!=typeof globalThis?globalThis:t||self).VueMoCropper=e(t.AlloyFinger,t.Vue)}(this,(function(t,e){"use strict";function i(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var s=i(t);const r="top-left",h="top-right",o="bottom-left",n="bottom-right";var a={name:"vue-mocropper",props:{modelValue:{type:Boolean,default:!1},cropWidth:{type:Number,default:200},cropHeight:{type:Number,default:200},src:{type:String,required:!0},outputMime:{type:String,default:"image/jpeg"},outputQuality:{type:Number,default:1},outputType:{type:String,default:"base64"},showMask:{type:Boolean,default:!0},cancelText:{type:String,default:"取消"},confirmText:{type:String,default:"裁剪"},resizable:{type:Boolean,default:!0}},data(){return{pCtx:null,cCtx:null,image:null,initWidth:0,initHeight:0,currentWidth:0,currentHeight:0,resizedWidth:0,resizedHeight:0,zoom:1,sX:null,sY:null,ratio:1,topX:0,topY:0,cropperWidth:this.cropWidth,cropperHeight:this.cropHeight,resizingCropper:!1,movingCropper:!1}},watch:{modelValue(t){t&&(this._reset(),this._loadImage())},src(t){this._reset(),t&&this._loadImage()}},methods:{_reset(){this.image=null,this.initWidth=0,this.initHeight=0,this.currentWidth=0,this.currentHeight=0,this.resizedWidth=0,this.resizedHeight=0,this.zoom=1,this.sX=null,this.sY=null,this.cCtx=this.$refs.cCanvas.getContext("2d"),this.pCtx=this.$refs.pCanvas.getContext("2d"),this.ratio=function(t){const e=t.backingStorePixelRatio||t.webkitBackingStorePixelRatio||t.mozBackingStorePixelRatio||t.msBackingStorePixelRatio||t.oBackingStorePixelRatio||t.backingStorePixelRatio||1;return(window.devicePixelRatio||1)/e}(this.cCtx),this.$refs.pCanvas.width=window.innerWidth*this.ratio,this.$refs.pCanvas.height=window.innerHeight*this.ratio,this._setcCanvasRect(),this._getCropperInitialPosition()},_setcCanvasRect(){this.$refs.cCanvas.width=this.cropperWidth*this.ratio,this.$refs.cCanvas.height=this.cropperHeight*this.ratio},_getCropperInitialPosition(){const t=window.innerWidth,e=window.innerHeight;this.topX=t/2-this.cropperWidth/2,this.topY=e/2-this.cropperHeight/2},_isInCropperArea(t,e){return t>=this.topX&&t<=this.topX+this.cropperWidth&&e>=this.topY&&e<=this.topY+this.cropperHeight},_isInCropperAngle(t,e){const i=15,s=15,a=10;return t>=this.topX-a&&t<=this.topX+i+a&&e>=this.topY-a&&e<=this.topY+s+a?r:t>=this.topX+this.cropperWidth-7.5-a&&t<=this.topX+this.cropperWidth+7.5+a&&e>=this.topY-a&&e<=this.topY+s+a?h:t>=this.topX-a&&t<=this.topX+i+a&&e>=this.topY+this.cropperHeight-7.5-a&&e<=this.topY+this.cropperHeight-7.5+a?o:t>=this.topX+this.cropperWidth-7.5-a&&t<=this.topX+this.cropperWidth+7.5+a&&e>=this.topY+this.cropperHeight-7.5-a&&e<=this.topY+this.cropperHeight-7.5+a&&n},_resizeCropper(t,e){switch(this.resizingCropper){case r:this.topX+=t,this.topY+=e,this.cropperWidth-=t,this.cropperHeight-=e;break;case h:this.topY+=e,this.cropperWidth+=t,this.cropperHeight-=e;break;case o:this.topX+=t,this.cropperWidth-=t,this.cropperHeight+=e;break;case n:this.cropperWidth+=t,this.cropperHeight+=e}this._setcCanvasRect(),this._drawCanvas()},isInLegalArea(t,e){return t>=this.sX&&t<this.sX+this.currentWidth&&e>=this.sY&&e<this.sY+this.currentHeight},_moveCropper(t,e){let i=!1;this.topX+t>=0&&this.topX+t+this.cropperWidth<=window.innerWidth&&(this.topX+=t,i=!0),this.topY+e>=0&&this.topY+e+this.cropperHeight<=window.innerHeight&&(this.topY+=e,i=!0),i&&this._drawCanvas()},_adjustImageSize(){let t=1;this.initWidth>window.innerWidth&&(t=window.innerWidth/this.initWidth),this.initHeight>window.innerHeight&&(t=Math.min(t,window.innerHeight/this.initHeight)),this.zoom=t,this.currentWidth=this.zoom*this.initWidth,this.currentHeight=this.zoom*this.initHeight,this.resizedWidth=this.currentWidth,this.resizedHeight=this.currentHeight},_loadImage(){const t=new Image;t.setAttribute("crossOrigin","Anonymous"),t.src=this.src,t.onload=()=>{this.image=t,this.initWidth=t.width,this.initHeight=t.height,this._adjustImageSize(),this._drawCanvas()},t.onerror=()=>{"development"===process.env.NODE_ENV&&console.error("Unable to load image, Please check whether the image URL is correct."),this.$emit("load-failed")}},_getStartPoint(){const t=(window.innerWidth-this.currentWidth)/2,e=(window.innerHeight-this.currentHeight)/2;this.sX=t,this.sY=e},_drawCanvas(t,e){const i=this.cCtx,s=this.pCtx,r=this.ratio,h=this.$refs.pCanvas,o=t=>"object"==typeof t&&null===t;(o(this.sX)||o(this.sY))&&this._getStartPoint();const n=this.topY,a=this.topX;t=t||this.currentWidth,e=e||this.currentHeight,s.fillStyle="#000",s.fillRect(0,0,h.width,h.height),s.drawImage(this.image,0,0,this.initWidth,this.initHeight,this.sX*r,this.sY*r,t*r,e*r),i.drawImage(this.$refs.pCanvas,a*r,n*r,this.cropperWidth*r,this.cropperHeight*r,0,0,this.cropperWidth*r,this.cropperHeight*r)},cropImage(){const t=t=>{const e=document.createElement("canvas");e.width=t.width/this.ratio,e.height=t.height/this.ratio;return e.getContext("2d").drawImage(t,0,0,t.width,t.height,0,0,e.width,e.height),e};try{let e=t(this.$refs.cCanvas).toDataURL(this.outputMime,this.outputQuality);"blob"===this.outputType&&(e=function(t){let e=t.split(","),i=e[0].match(/:(.*?);/)[1],s=atob(e[1]),r=s.length,h=new Uint8Array(r);for(;r--;)h[r]=s.charCodeAt(r);return new Blob([h],{type:i})}(e)),this.$emit("crop-done",e)}catch(t){this.$emit("crop-failed",t)}},cancel(){this.$emit("update:modelValue",!1)}},mounted(){new s.default(this.$refs.gesture,{pressMove:t=>{const{clientX:e,clientY:i}=t.touches[0];return this.resizingCropper?this._resizeCropper(t.deltaX,t.deltaY):this.movingCropper?this._moveCropper(t.deltaX,t.deltaY):void(this.isInLegalArea(e,i)&&(this.sX+=t.deltaX,this.sY+=t.deltaY,this._drawCanvas()))},pinch:t=>{const e=t.zoom*this.currentWidth,i=t.zoom*this.currentHeight;e>2*this.initWidth||i>2*this.initHeight||(this.sX+=(this.resizedWidth-e)/2,this.sY+=(this.resizedHeight-i)/2,this.resizedWidth=e,this.resizedHeight=i,this._drawCanvas(this.resizedWidth,this.resizedHeight))},touchStart:t=>{const e=t.touches[0].clientX,i=t.touches[0].clientY;this.resizingCropper=this.resizable&&this._isInCropperAngle(e,i),this.movingCropper=this._isInCropperArea(e,i)},touchEnd:t=>{this.currentWidth=this.resizedWidth,this.currentHeight=this.resizedHeight,this.resizingCropper=!1,this.movingCropper=!1}});this._reset()}};const p=e.withScopeId("data-v-1a7c0ba2");e.pushScopeId("data-v-1a7c0ba2");const c={class:"cutout"},d={class:"previewer",ref:"pCanvas"},l={key:0,class:"mask"},g={class:"cropper",ref:"cCanvas"},u={class:"cropper-angle top-left"},m={class:"cropper-angle top-right"},v={class:"cropper-angle bottom-left"},w={class:"cropper-angle bottom-right"},f={class:"menu"};e.popScopeId();const C=p((function(t,i,s,r,h,o){return e.withDirectives((e.openBlock(),e.createBlock("div",c,[e.createCommentVNode("预览Canvas"),e.createVNode("canvas",d,null,512),e.createCommentVNode("遮罩层"),s.showMask?(e.openBlock(),e.createBlock("div",l)):e.createCommentVNode("v-if",!0),e.createCommentVNode(" 裁剪Canvas "),e.createVNode("div",{class:"cropper-wrapper",style:{top:h.topY+"px",left:h.topX+"px",width:h.cropperWidth+"px",height:h.cropperHeight+"px"}},[e.createVNode("canvas",g,null,512),e.withDirectives(e.createVNode("div",u,null,512),[[e.vShow,s.resizable]]),e.withDirectives(e.createVNode("div",m,null,512),[[e.vShow,s.resizable]]),e.withDirectives(e.createVNode("div",v,null,512),[[e.vShow,s.resizable]]),e.withDirectives(e.createVNode("div",w,null,512),[[e.vShow,s.resizable]])],4),e.createCommentVNode(" 手势接收层 "),e.createVNode("div",{class:"gesture-layer",ref:"gesture",onTouchmove:i[1]||(i[1]=e.withModifiers((t=>{}),["prevent"]))},null,544),e.createCommentVNode(" 插槽，可自定义按钮等内容 "),e.renderSlot(t.$slots,"default",{cancel:o.cancel,crop:o.cropImage},(()=>[e.createVNode("div",f,[e.createVNode("button",{class:"menu_button cancel",onClick:i[2]||(i[2]=(...t)=>o.cancel(...t))},e.toDisplayString(s.cancelText),1),e.createVNode("button",{class:"menu_button confirm",onClick:i[3]||(i[3]=(...t)=>o.cropImage(...t))},e.toDisplayString(s.confirmText),1)])]))],512)),[[e.vShow,s.modelValue]])}));a.render=C,a.__scopeId="data-v-1a7c0ba2",a.__file="src/mocropper.vue";return{install(t){t.component(a.name,a)}}}));
